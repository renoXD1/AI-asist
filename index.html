<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>AI Chat Assistant</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <link rel="stylesheet" href="/style.css" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#202123" />
  </head>
  <body>
    <div id="app">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <button id="new-chat-btn">+ Chat Baru</button>
        </div>
        <div class="sidebar-chats" id="chat-list"></div>
        <div class="sidebar-footer">
          <div class="brand">AI Assistant</div>
          <div class="note">Mode dark, PWA ready</div>
        </div>
      </aside>

      <!-- MAIN CHAT AREA -->
      <main class="main">
        <header class="main-header">
          <div class="title">AI Chat</div>
          <div class="subtitle">Mirip ChatGPT, berjalan di browser</div>
        </header>

        <section class="messages" id="messages"></section>

        <footer class="input-area">
          <form id="chat-form">
            <textarea
              id="input"
              rows="1"
              placeholder="Ketik pesan di sini dan tekan Enter..."
            ></textarea>
            <button id="send-btn" type="submit">Kirim</button>
          </form>
          <div class="status" id="status">
            Aplikasi ini hanya untuk tujuan edukasi.
          </div>
        </footer>
      </main>
    </div>

    <script>
      // ====== STATE DASAR ======
      const messagesEl = document.getElementById('messages');
      const chatListEl = document.getElementById('chat-list');
      const inputEl = document.getElementById('input');
      const formEl = document.getElementById('chat-form');
      const statusEl = document.getElementById('status');
      const newChatBtn = document.getElementById('new-chat-btn');

      // Struktur:
      // chats = [
      //   { id: '...', title: '...', messages: [ {role, content}, ... ] }
      // ]
      let chats = [];
      let activeChatId = null;
      const STORAGE_KEY = 'ai_chat_pwa_chats';

      // ====== UTIL ID ======
      function uuid() {
        return 'xxxxxx'.replace(/x/g, () =>
          ((Math.random() * 36) | 0).toString(36)
        );
      }

      // ====== LOCAL STORAGE ======
      function loadChats() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) chats = parsed;
        } catch (e) {
          console.error('Failed to load chats', e);
        }
      }

      function saveChats() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
        } catch (e) {
          console.error('Failed to save chats', e);
        }
      }

      // ====== CHAT MANAGEMENT ======
      function createNewChat(initialMessage) {
        const id = uuid();
        const chat = {
          id,
          title: initialMessage
            ? initialMessage.slice(0, 30) + (initialMessage.length > 30 ? '…' : '')
            : 'Chat Baru',
          messages: []
        };
        chats.unshift(chat);
        activeChatId = id;
        saveChats();
        renderChatList();
        renderActiveChat();
        return chat;
      }

      function setActiveChat(id) {
        activeChatId = id;
        renderChatList();
        renderActiveChat();
      }

      function getActiveChat() {
        return chats.find((c) => c.id === activeChatId) || null;
      }

      function addMessageToActiveChat(role, content) {
        let chat = getActiveChat();
        if (!chat) {
          chat = createNewChat(
            role === 'user' ? content : 'Chat Baru'
          );
        }
        chat.messages.push({ role, content });
        if (role === 'user' && chat.messages.length === 1) {
          chat.title =
            content.slice(0, 30) + (content.length > 30 ? '…' : '');
        }
        saveChats();
      }

      // ====== RENDERING ======
      function renderChatList() {
        chatListEl.innerHTML = '';
        chats.forEach((chat) => {
          const div = document.createElement('div');
          div.className =
            'chat-list-item' + (chat.id === activeChatId ? ' active' : '');
          div.textContent = chat.title;
          div.onclick = () => setActiveChat(chat.id);
          chatListEl.appendChild(div);
        });
      }

      function renderActiveChat() {
        messagesEl.innerHTML = '';
        const chat = getActiveChat();
        if (!chat || chat.messages.length === 0) {
          // pesan default
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.textContent =
            'Mulai percakapan baru dengan mengetik di bawah.';
          messagesEl.appendChild(empty);
          return;
        }

        chat.messages.forEach((m) => {
          appendMessageBubble(m.role, m.content);
        });

        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function appendMessageBubble(role, content) {
        const row = document.createElement('div');
        row.className = 'message-row ' + role;

        const bubble = document.createElement('div');
        bubble.className =
          'message-bubble ' + (role === 'user' ? 'user' : 'assistant');
        bubble.textContent = content;

        row.appendChild(bubble);
        messagesEl.appendChild(row);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        return bubble; // untuk streaming
      }

      // ====== STREAMING (EFEK KETIK) ======
      function streamTextToBubble(bubble, fullText, speed = 10) {
        bubble.textContent = '';
        let idx = 0;
        return new Promise((resolve) => {
          const interval = setInterval(() => {
            bubble.textContent += fullText.charAt(idx);
            idx++;
            messagesEl.scrollTop = messagesEl.scrollHeight;
            if (idx >= fullText.length) {
              clearInterval(interval);
              resolve();
            }
          }, speed);
        });
      }

      // ====== HANDLE SUBMIT ======
      formEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = inputEl.value.trim();
        if (!text) return;

        // user message
        addMessageToActiveChat('user', text);
        appendMessageBubble('user', text);
        inputEl.value = '';
        inputEl.style.height = 'auto';

        // assistant placeholder
        const placeholderBubble = appendMessageBubble(
          'assistant',
          'Sedang berpikir...'
        );

        statusEl.textContent = 'AI sedang menjawab...';

        try {
          const res = await fetch('/api/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ q: text })
          });

          const data = await res.json();
          const answer =
            data && data.text
              ? data.text
              : 'Maaf, tidak ada jawaban yang bisa ditampilkan.';

          // update chat state
          addMessageToActiveChat('assistant', answer);
          saveChats();

          // streaming efek ketik
          await streamTextToBubble(placeholderBubble, answer, 12);
        } catch (err) {
          console.error(err);
          placeholderBubble.textContent =
            'Terjadi error jaringan/server. Coba lagi nanti.';
        } finally {
          statusEl.textContent =
            'Aplikasi ini hanya untuk tujuan edukasi. Respons dapat salah, harap verifikasi.';
        }
      });

      // textarea auto-grow
      inputEl.addEventListener('input', () => {
        inputEl.style.height = 'auto';
        inputEl.style.height = inputEl.scrollHeight + 'px';
      });

      // new chat
      newChatBtn.addEventListener('click', () => {
        const chat = createNewChat();
        setActiveChat(chat.id);
      });

      // ====== INIT ======
      loadChats();
      if (chats.length === 0) {
        const chat = createNewChat();
        setActiveChat(chat.id);
      } else {
        activeChatId = chats[0].id;
      }
      renderChatList();
      renderActiveChat();

      // ====== PWA SERVICE WORKER ======
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('/service-worker.js')
            .catch((err) => console.error('SW register failed:', err));
        });
      }
    </script>
  </body>
</html>
